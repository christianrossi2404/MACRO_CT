Option Explicit

Sub Rellenar_Plantilla_Word_UnaFila()

    ' --- DECLARACIÓN DE VARIABLES ---
    Dim wordApp As Object
    Dim doc As Object
    Dim hoja As Worksheet
    Dim Hoja100 As Worksheet
    Dim Costes As Worksheet
    Dim fila As Long
    Dim rutaPlantilla As String, rutaSalida As String
    
    ' Variables para los condicionales
    Dim ManometroAnalogico As String
    Dim ManometroElectronico As String
    Dim longitudMM As String
    Dim diamCol As Variant
    Dim diamEle As Variant
    Dim contador As String
    Dim AnguloTlv As String

    
    
    On Error GoTo ErrorHandler

    ' --- CONFIGURACIÓN DE HOJAS Y RUTAS ---
    Set hoja = ThisWorkbook.Sheets("Inicio")
    Set Hoja100 = ThisWorkbook.Sheets("Hoja100")
    Set Costes = ThisWorkbook.Sheets("Costes")
    fila = 2
    
    ' Esta es la sección del código que ha sido movida
    ' Sub MostrarRutaDelLibro()
    '     ' Muestra la ruta completa del libro de Excel.
    '     MsgBox "La ruta de este libro es: " & ThisWorkbook.Path
    ' End Sub
    
    'rutaPlantilla = ThisWorkbook.Path & "\CARACTERISTICAS TECNICAS.docx"
    rutaPlantilla = "Y:\COSTES\PLANTILLAS\CARACTERISTICAS TECNICAS.docx"
    'rutaPlantilla = "C:\Users\Christian Rossi\PRUEBAS\CT_excel\CARACTERISTICAS TECNICAS.docx"
    
    ' Crea el nombre del archivo de salida de forma dinámica
    rutaSalida = ThisWorkbook.Path & "\CT-" & hoja.Range("E6").Value & ".docx"
    'rutaSalida = "C:\Users\Christian Rossi\PRUEBAS\CT_excel\CT-" & hoja.Range("E6").Value & ".docx"
    
    If Dir(rutaPlantilla) = "" Then
        MsgBox "No se encontró la plantilla: " & rutaPlantilla, vbCritical
        Exit Sub
    End If

    ' --- INICIAR WORD ---
    Set wordApp = CreateObject("Word.Application")
    wordApp.Visible = True
    Set doc = wordApp.Documents.Add(rutaPlantilla)
    
    ' --- LÓGICA CONDICIONAL: ASIGNACIÓN DE VALORES ---
    ' Condicional para Manómetros
    If Costes.Range("E29").Value = "0" Then
        ManometroAnalogico = "-"
        ManometroElectronico = "Timer-manómetro. 220 Vac / IP56 / 50 Hz / signal 4-20 mA"
    Else
        ManometroAnalogico = "Esfera 0-300 mmca"
        ManometroElectronico = "Timer-manómetro. 220 Vac / IP56 / 50 Hz"
    End If
    
    ' Angulo tolva 60 / 70 º
    If Hoja100.Range("F71").Value = "2" Then
        AnguloTlv = "70"
    Else
        AnguloTlv = "60"
    End If
    
    
    ' Condicional para longitud de las mangas
    Select Case Hoja100.Range("A93").Value
        Case 4
            longitudMM = "1.261"
        Case 6
            longitudMM = "1.870"
        Case 8
            longitudMM = "2.479"
        Case 10
            longitudMM = "3.088"
        Case 12
            longitudMM = "3.697"
        Case Else
            longitudMM = "0"
    End Select
    
    ' Condicional para los diámetros
    Select Case Hoja100.Range("L189").Value
        Case 2, 3, 8, 9
            diamCol = 6
            diamEle = 1
        Case 4, 5, 10, 11
            diamCol = 8
            diamEle = "1 1/2"
        Case 6, 7, 12, 13
            diamCol = 8
            diamEle = 2
        Case Else
            diamCol = ""
            diamEle = ""
    End Select
    
    ' Obtiene los primeros 2 caracteres del nombre del archivo para el contador
    ' Esta linea fue comentada por ti, la mantengo asi
    ' contador = Left(ThisWorkbook.Name, 2)
    
    ' --- REEMPLAZAR TODOS LOS CAMPOS EN EL CUERPO PRINCIPAL ---
    Call ReemplazarCampo(doc, "{{NOF}}", hoja.Range("B5").Value)
    Call ReemplazarCampo(doc, "{{CAUDAL}}", Format(hoja.Range("B9").Value, "#,##0"))
    Call ReemplazarCampo(doc, "{{PRODUCT}}", hoja.Range("B14").Value)
    Call ReemplazarCampo(doc, "{{CONC}}", IIf(IsEmpty(hoja.Range("B11").Value) Or hoja.Range("B11").Value = 0, "20÷30", hoja.Range("B11").Value))
    Call ReemplazarCampo(doc, "{{DENS}}", IIf(IsEmpty(hoja.Range("B15").Value) Or hoja.Range("B15").Value = 0, "800", hoja.Range("B15").Value))
    Call ReemplazarCampo(doc, "{{TEMPERATURA}}", hoja.Range("B10").Value)
    Call ReemplazarCampo(doc, "{{FILTRO}}", hoja.Range("E6").Value)
    Call ReemplazarCampo(doc, "{{SUP_FILTRANTE}}", hoja.Range("F28").Value)
    Call ReemplazarCampo(doc, "{{RATIO_F}}", Format(hoja.Range("F29").Value, "0.00"))
    Call ReemplazarCampo(doc, "{{CONSUMO_AIRE}}", Format(hoja.Range("F30").Value, "0"))
    Call ReemplazarCampo(doc, "{{P_T}}", hoja.Range("E15").Value)
    Call ReemplazarCampo(doc, "{{P_d}}", hoja.Range("E16").Value)
    Call ReemplazarCampo(doc, "{{ESP_CAL}}", hoja.Range("E9").Value)
    Call ReemplazarCampo(doc, "{{ESP_VENT}}", hoja.Range("B30").Value)
    Call ReemplazarCampo(doc, "{{ESP_CAS}}", hoja.Range("E10").Value)
    Call ReemplazarCampo(doc, "{{ESP_TOLVA}}", hoja.Range("E11").Value)
    Call ReemplazarCampo(doc, "{{ANG}}", AnguloTlv)
    Call ReemplazarCampo(doc, "{{MAT_MANGA}}", Hoja100.Range("AZ72").Value)
    Call ReemplazarCampo(doc, "{{NUM_MANGAS}}", hoja.Range("B20").Value)
    Call ReemplazarCampo(doc, "{{LONG_MANGA}}", longitudMM)
    Call ReemplazarCampo(doc, "{{MAT_JAULA}}", Hoja100.Range("B70").Value)
    Call ReemplazarCampo(doc, "{{NUM_VALV}}", hoja.Range("B26").Value)
    Call ReemplazarCampo(doc, "{{TIMER_MAN_CT}}", ManometroElectronico)
    Call ReemplazarCampo(doc, "{{MAN_CT}}", ManometroAnalogico)
    Call ReemplazarCampo(doc, "{{DIAM_COL}}", diamCol)
    Call ReemplazarCampo(doc, "{{DIAM_ELE}}", diamEle)
    Call ReemplazarCampo(doc, "{{BAR}}", Hoja100.Range("BY3").Value)
    ' Esta linea fue comentada por ti, la mantengo asi
    ' Call ReemplazarCampo(doc, "{{CONTADOR}}", contador)
    
    ' --- AÑADIR NOF AL FOOTER ---
    Dim seccion As Object
    Dim pieDePagina As Object
    Dim i As Long
    
    For Each seccion In doc.Sections
        For i = 1 To seccion.Footers.Count
            Set pieDePagina = seccion.Footers(i)
            With pieDePagina.Range.Find
                .ClearFormatting
                .Replacement.ClearFormatting
                .Text = "{{NOF}}"
                .Replacement.Text = hoja.Range("B5").Value
                .Replacement.Font.Name = "Arial"
                .Replacement.Font.Size = 9
                .Execute Replace:=2
            End With
            
            ' --- ACTUALIZAR CAMPOS DEL FOOTER ---
            pieDePagina.Range.Fields.Update
            ' -----------------------------------
        Next i
    Next seccion

    ' --- GUARDAR DOCUMENTO Y FINALIZAR ---
    doc.SaveAs2 rutaSalida, FileFormat:=16
    MsgBox "Documento completado guardado en:" & vbCrLf & rutaSalida, vbInformation

    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
    If Not doc Is Nothing Then doc.Close False
    If Not wordApp Is Nothing Then wordApp.Quit
    Set doc = Nothing
    Set wordApp = Nothing
End Sub

' Esta subrutina aplica el formato Arial 9 a los campos del cuerpo principal
Sub ReemplazarCampo(doc As Object, marcador As String, valor As Variant)
    With doc.Content.Find
        .ClearFormatting
        .Replacement.ClearFormatting
        .Text = marcador
        .Replacement.Text = IIf(IsEmpty(valor), "", valor)
        
        .Replacement.Font.Name = "Arial"
        .Replacement.Font.Size = 9
        
        .Execute Replace:=2
    End With
End Sub